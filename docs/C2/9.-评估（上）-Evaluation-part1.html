
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <title>9. 评估（上）Evaluation-part1 · HonKit</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="HonKit 5.1.4">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/@honkit/honkit-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="10.-评估（下）Evaluation-part2.html" />
    
    
    <link rel="prev" href="8.-搭建一个带评估的端到端问答系统-Evaluation.html" />
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    目录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../前言.html">
            
                <a href="../前言.html">
            
                    
                    前言
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../环境配置.html">
            
                <a href="../环境配置.html">
            
                    
                    环境配置
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">第一部分 面向开发者的提示工程</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../C1/readme.html">
            
                <a href="../C1/readme.html">
            
                    
                    0. 概述
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../C1/1.-简介-Introduction.html">
            
                <a href="../C1/1.-简介-Introduction.html">
            
                    
                    1. 简介 Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../C1/2.-提示原则-Guidelines.html">
            
                <a href="../C1/2.-提示原则-Guidelines.html">
            
                    
                    2. 提示原则 Guidelines
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="../C1/3.-迭代优化-Iterative.html">
            
                <a href="../C1/3.-迭代优化-Iterative.html">
            
                    
                    3. 迭代优化 Iterative
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="../C1/4.-文本概括-Summarizing.html">
            
                <a href="../C1/4.-文本概括-Summarizing.html">
            
                    
                    4. 文本概括 Summarizing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="../C1/5.-推断-Inferring.html">
            
                <a href="../C1/5.-推断-Inferring.html">
            
                    
                    5. 推断 Inferring
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.7" data-path="../C1/6.-文本转换-Transforming.html">
            
                <a href="../C1/6.-文本转换-Transforming.html">
            
                    
                    6. 文本转换 Transforming
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.8" data-path="../C1/7.-文本扩展-Expanding.html">
            
                <a href="../C1/7.-文本扩展-Expanding.html">
            
                    
                    7. 文本扩展 Expanding
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.9" data-path="../C1/8.-聊天机器人-Chatbot.html">
            
                <a href="../C1/8.-聊天机器人-Chatbot.html">
            
                    
                    8. 聊天机器人 Chatbot
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.10" data-path="../C1/9.-总结-Summary.html">
            
                <a href="../C1/9.-总结-Summary.html">
            
                    
                    9. 总结 Summary
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">第二部分 搭建基于 ChatGPT 的问答系统</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="readme.html">
            
                <a href="readme.html">
            
                    
                    0. 概述
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="1.-简介-Introduction.html">
            
                <a href="1.-简介-Introduction.html">
            
                    
                    1. 简介 Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="2.-语言模型，提问范式与-Token-Language-Models,-the-Chat-Format-and-Tokens.html">
            
                <a href="2.-语言模型，提问范式与-Token-Language-Models,-the-Chat-Format-and-Tokens.html">
            
                    
                    2. 语言模型，提问范式与 Token Language Models, the Chat Format and Tokens
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="3.-评估输入-分类-Classification.html">
            
                <a href="3.-评估输入-分类-Classification.html">
            
                    
                    3. 评估输入-分类 Classification
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.5" data-path="4.-检查输入-监督-Moderation.html">
            
                <a href="4.-检查输入-监督-Moderation.html">
            
                    
                    4. 检查输入-监督 Moderation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.6" data-path="5.-处理输入-思维链推理-Chain-of-Thought-Reasoning.html">
            
                <a href="5.-处理输入-思维链推理-Chain-of-Thought-Reasoning.html">
            
                    
                    5. 思维链推理 Chain of Thought Reasoning
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.7" data-path="6.-处理输入-链式-Prompt-Chaining-Prompts.html">
            
                <a href="6.-处理输入-链式-Prompt-Chaining-Prompts.html">
            
                    
                    6. Prompt 链 Chaining Prompts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.8" data-path="7.-检查结果-Check-Outputs.html">
            
                <a href="7.-检查结果-Check-Outputs.html">
            
                    
                    7. 检查结果 Check Outputs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.9" data-path="8.-搭建一个带评估的端到端问答系统-Evaluation.html">
            
                <a href="8.-搭建一个带评估的端到端问答系统-Evaluation.html">
            
                    
                    8. 搭建一个带评估的端到端系统 Evaluation
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="3.10" data-path="9.-评估（上）-Evaluation-part1.html">
            
                <a href="9.-评估（上）-Evaluation-part1.html">
            
                    
                    9. 评估（上）Evaluation-part1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.11" data-path="10.-评估（下）Evaluation-part2.html">
            
                <a href="10.-评估（下）Evaluation-part2.html">
            
                    
                    10. 评估（下）Evaluation-part2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.12" data-path="11.总结-conclusion.html">
            
                <a href="11.总结-conclusion.html">
            
                    
                    11. 总结 Conclusion
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">第三部分 使用 LangChain 开发应用程序</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="../C3/readme.html">
            
                <a href="../C3/readme.html">
            
                    
                    0. 概述
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="../C3/1.-简介-Introduction.html">
            
                <a href="../C3/1.-简介-Introduction.html">
            
                    
                    1. 简介 Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="../C3/2.-模型、提示和解析器-Models,-Prompts-and-Output-Parsers.html">
            
                <a href="../C3/2.-模型、提示和解析器-Models,-Prompts-and-Output-Parsers.html">
            
                    
                    2. 模型、提示和解析器 Models, Prompts and Parsers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="../C3/3.-储存-Memory.html">
            
                <a href="../C3/3.-储存-Memory.html">
            
                    
                    3. 储存 Memory
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.5" data-path="../C3/4.-模型链-Chains.html">
            
                <a href="../C3/4.-模型链-Chains.html">
            
                    
                    4. 模型链 Chains
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.6" data-path="../C3/5.-基于文档的问答-Question-and-Answer.html">
            
                <a href="../C3/5.-基于文档的问答-Question-and-Answer.html">
            
                    
                    5. 基于文档的问答 Question and Answer
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.7" data-path="../C3/6.-评估-Evaluation.html">
            
                <a href="../C3/6.-评估-Evaluation.html">
            
                    
                    6. 评估 Evaluation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.8" data-path="../C3/7.-代理-Agent.html">
            
                <a href="../C3/7.-代理-Agent.html">
            
                    
                    7. 代理 Agent
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.9" data-path="../C3/8.-总结-Conclusion.html">
            
                <a href="../C3/8.-总结-Conclusion.html">
            
                    
                    8. 总结 Conclusion
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">第四部分 使用 LangChain 访问个人数据</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../C4/readme.html">
            
                <a href="../C4/readme.html">
            
                    
                    0. 概述
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="../C4/1.-简介-Introduction.html">
            
                <a href="../C4/1.-简介-Introduction.html">
            
                    
                    1. 简介 Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3" data-path="../C4/2.-文档加载-Document-Loading.html">
            
                <a href="../C4/2.-文档加载-Document-Loading.html">
            
                    
                    2. 文档加载 Document Loading
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.4" data-path="../C4/3.-文档分割-Splitting.html">
            
                <a href="../C4/3.-文档分割-Splitting.html">
            
                    
                    3. 文档分割 Splitting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.5" data-path="../C4/4.-向量数据库与词向量-Vectorstores-and-Embeddings.html">
            
                <a href="../C4/4.-向量数据库与词向量-Vectorstores-and-Embeddings.html">
            
                    
                    4. 向量数据库与词向量 Vectorstores and Embeddings
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.6" data-path="../C4/5.-检索-Retrieval.html">
            
                <a href="../C4/5.-检索-Retrieval.html">
            
                    
                    5. 检索 Retrieval
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.7" data-path="../C4/6.-问答-Question-Answering.html">
            
                <a href="../C4/6.-问答-Question-Answering.html">
            
                    
                    6. 问答 Question ANswering
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.8" data-path="../C4/7.-聊天-Chat.html">
            
                <a href="../C4/7.-聊天-Chat.html">
            
                    
                    7. 聊天 Chat
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.9" data-path="../C4/8.-总结-Summary.html">
            
                <a href="../C4/8.-总结-Summary.html">
            
                    
                    8. 总结 Summary
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://github.com/honkit/honkit" target="blank" class="gitbook-link">
            Published with HonKit
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >9. 评估（上）Evaluation-part1</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="第九章-评估（上）——存在一个简单的正确答案时">第九章 评估（上）——存在一个简单的正确答案时</h1>
<p>在过去的章节里，我们向你展示了如何借助 LLM 构建应用程序，包括评估输入，处理输入，以及在呈现结果给用户之前进行最后的结果检查。然而，在构建出这样的系统后，我们应如何确知其运行状况呢？更甚者，当我们将其部署并让用户开始使用之后，我们又该如何追踪其表现，发现可能存在的问题，并持续优化它的回答质量呢？在本章里，我们将向你分享一些评估LLM输出的最佳实践。</p>
<p>构建基于LLM的应用程序与构建传统的监督学习应用程序有所不同。因为你可以快速地构建出基于LLM的应用程序，所以评估通常不从测试集开始。相反，你会逐渐地建立起一个测试样例的集合。</p>
<p>在传统的监督学习环境下，你需要收集训练集、开发集，或者留出交叉验证集，在整个开发过程中都会用到它们。然而，如果你能够在几分钟内定义一个 Prompt ，并在几小时内得到反馈结果，那么停下来收集一千个测试样本就会显得极为繁琐。因为现在，你可以在没有任何训练样本的情况下得到结果。</p>
<p>因此，在使用LLM构建应用程序时，你可能会经历以下流程：首先，你会在一到三个样本的小样本中调整 Prompt ，尝试使其在这些样本上起效。随后，当你对系统进行进一步测试时，可能会遇到一些棘手的例子，这些例子无法通过 Prompt 或者算法解决。这就是使用 ChatGPT API 构建应用程序的开发者所面临的挑战。在这种情况下，你可以将这些额外的几个例子添加到你正在测试的集合中，有机地添加其他难以处理的例子。最终，你会将足够多的这些例子添加到你逐步扩大的开发集中，以至于手动运行每一个例子以测试 Prompt 变得有些不便。然后，你开始开发一些用于衡量这些小样本集性能的指标，例如平均准确度。这个过程的有趣之处在于，如果你觉得你的系统已经足够好了，你可以随时停止，不再进行改进。实际上，很多已经部署的应用程序就在第一步或第二步就停下来了，而且它们运行得非常好。</p>
<p>值得注意的是，很多大型模型的应用程序没有实质性的风险，即使它没有给出完全正确的答案。但是，对于一些高风险的应用，如若存在偏见或不适当的输出可能对某人造成伤害，那么收集测试集、严格评估系统的性能，以及确保它在使用前能做对事情，就显得尤为重要。然而，如果你仅仅是用它来总结文章供自己阅读，而不是给其他人看，那么可能带来的风险就会较小，你可以在这个过程中早早地停止，而不必付出收集大规模数据集的巨大代价。</p>
<p>现在让我们进入更实际的应用阶段，将刚才所学的理论知识转化为实践。让我们一起研究一些真实的数据，理解其结构并使用我们的工具来分析它们。在我们的案例中，我们获取一组分类信息及其产品名称。让我们执行以下代码，以查看这些分类信息及其产品名称</p>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> utils_zh

products_and_category = utils_zh.get_products_and_category()
products_and_category
</code></pre>
<pre><code>{'电脑和笔记本': ['TechPro 超极本',
  'BlueWave 游戏本',
  'PowerLite Convertible',
  'TechPro Desktop',
  'BlueWave Chromebook'],
 '智能手机和配件': ['SmartX ProPhone'],
 '专业手机': ['MobiTech PowerCase',
  'SmartX MiniPhone',
  'MobiTech Wireless Charger',
  'SmartX EarBuds'],
 '电视和家庭影院系统': ['CineView 4K TV',
  'SoundMax Home Theater',
  'CineView 8K TV',
  'SoundMax Soundbar',
  'CineView OLED TV'],
 '游戏机和配件': ['GameSphere X',
  'ProGamer Controller',
  'GameSphere Y',
  'ProGamer Racing Wheel',
  'GameSphere VR Headset'],
 '音频设备': ['AudioPhonic Noise-Canceling Headphones',
  'WaveSound Bluetooth Speaker',
  'AudioPhonic True Wireless Earbuds',
  'WaveSound Soundbar',
  'AudioPhonic Turntable'],
 '相机和摄像机': ['FotoSnap DSLR Camera',
  'ActionCam 4K',
  'FotoSnap Mirrorless Camera',
  'ZoomMaster Camcorder',
  'FotoSnap Instant Camera']}
</code></pre><h2 id="一、找出相关产品和类别名称">一、找出相关产品和类别名称</h2>
<p>在我们进行开发时，通常需要处理和解析用户的输入。特别是在电商领域，可能会有各种各样的用户查询，例如："我想要最贵的电脑"。我们需要一个能理解这种语境，并能给出相关产品和类别的工具。下面这段代码实现的功能就是这样。</p>
<p>首先我们定义了一个函数<code>find_category_and_product_v1</code>，这个函数的主要目的是从用户的输入中解析出产品和类别。这个函数需要两个参数：<code>user_input</code>代表用户的查询，<code>products_and_category</code>是一个字典，其中包含了产品类型和对应产品的信息。</p>
<p>在函数的开始，我们定义了一个分隔符<code>delimiter</code>，用来在客户服务查询中分隔内容。随后，我们创建了一条系统消息。这条消息主要解释了系统的运作方式：用户会提供客户服务查询，查询会被分隔符<code>delimiter</code>分隔。系统会输出一个Python列表，列表中的每个对象都是Json对象。每个对象会包含'类别'和'名称'两个字段，分别对应产品的类别和名称。</p>
<p>我们创建了一个名为<code>messages</code>的列表，用来存储这些示例对话以及用户的查询。最后，我们使用<code>get_completion_from_messages</code>函数处理这些消息，返回处理结果。</p>
<p>通过这段代码，我们可以看到如何通过对话的方式理解和处理用户的查询，以提供更好的用户体验。</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> tool <span class="hljs-keyword">import</span> get_completion_from_messages

<span class="hljs-keyword">def</span> <span class="hljs-title function_">find_category_and_product_v1</span>(<span class="hljs-params">user_input,products_and_category</span>):
    <span class="hljs-string">"""
    从用户输入中获取到产品和类别

    参数：
    user_input：用户的查询
    products_and_category：产品类型和对应产品的字典
    """</span>

    delimiter = <span class="hljs-string">"####"</span>
    system_message = <span class="hljs-string">f"""
    您将提供客户服务查询。\
    客户服务查询将用<span class="hljs-subst">{delimiter}</span>字符分隔。
    输出一个 Python 列表，列表中的每个对象都是 Json 对象，每个对象的格式如下：
        '类别': &lt;电脑和笔记本, 智能手机和配件, 电视和家庭影院系统, \
    游戏机和配件, 音频设备, 相机和摄像机中的一个&gt;,
    以及
        '名称': &lt;必须在下面允许的产品中找到的产品列表&gt;

    其中类别和产品必须在客户服务查询中找到。
    如果提到了一个产品，它必须与下面允许的产品列表中的正确类别关联。
    如果没有找到产品或类别，输出一个空列表。

    根据产品名称和产品类别与客户服务查询的相关性，列出所有相关的产品。
    不要从产品的名称中假设任何特性或属性，如相对质量或价格。

    允许的产品以 JSON 格式提供。
    每个项目的键代表类别。
    每个项目的值是该类别中的产品列表。
    允许的产品：<span class="hljs-subst">{products_and_category}</span>

    """</span>

    few_shot_user_1 = <span class="hljs-string">"""我想要最贵的电脑。"""</span>
    few_shot_assistant_1 = <span class="hljs-string">""" 
    [{'category': '电脑和笔记本', \
'products': ['TechPro 超极本', 'BlueWave 游戏本', 'PowerLite Convertible', 'TechPro Desktop', 'BlueWave Chromebook']}]
    """</span>

    messages =  [  
    {<span class="hljs-string">'role'</span>:<span class="hljs-string">'system'</span>, <span class="hljs-string">'content'</span>: system_message},    
    {<span class="hljs-string">'role'</span>:<span class="hljs-string">'user'</span>, <span class="hljs-string">'content'</span>: <span class="hljs-string">f"<span class="hljs-subst">{delimiter}</span><span class="hljs-subst">{few_shot_user_1}</span><span class="hljs-subst">{delimiter}</span>"</span>},  
    {<span class="hljs-string">'role'</span>:<span class="hljs-string">'assistant'</span>, <span class="hljs-string">'content'</span>: few_shot_assistant_1 },
    {<span class="hljs-string">'role'</span>:<span class="hljs-string">'user'</span>, <span class="hljs-string">'content'</span>: <span class="hljs-string">f"<span class="hljs-subst">{delimiter}</span><span class="hljs-subst">{user_input}</span><span class="hljs-subst">{delimiter}</span>"</span>},  
    ] 
    <span class="hljs-keyword">return</span> get_completion_from_messages(messages)
</code></pre>
<h2 id="二、在一些查询上进行评估">二、在一些查询上进行评估</h2>
<p>对上述系统，我们可以首先在一些简单查询上进行评估：</p>
<pre><code class="lang-python"><span class="hljs-comment"># 第一个评估的查询</span>
customer_msg_0 = <span class="hljs-string">f"""如果我预算有限，我可以买哪款电视？"""</span>

products_by_category_0 = find_category_and_product_v1(customer_msg_0,
                                                      products_and_category)
<span class="hljs-built_in">print</span>(products_by_category_0)
</code></pre>
<pre><code>    [{'category': '电视和家庭影院系统', 'products': ['CineView 4K TV', 'SoundMax Home Theater', 'CineView 8K TV', 'SoundMax Soundbar', 'CineView OLED TV']}]
</code></pre><p>输出了正确回答。</p>
<pre><code class="lang-python">customer_msg_1 = <span class="hljs-string">f"""我需要一个智能手机的充电器"""</span>

products_by_category_1 = find_category_and_product_v1(customer_msg_1,
                                                      products_and_category)
<span class="hljs-built_in">print</span>(products_by_category_1)
</code></pre>
<pre><code>    [{'category': '智能手机和配件', 'products': ['MobiTech PowerCase', 'SmartX MiniPhone', 'MobiTech Wireless Charger', 'SmartX EarBuds']}]
</code></pre><p>输出了正确回答。</p>
<pre><code class="lang-python">customer_msg_2 = <span class="hljs-string">f"""
你们有哪些电脑？"""</span>

products_by_category_2 = find_category_and_product_v1(customer_msg_2,
                                                      products_and_category)
products_by_category_2
</code></pre>
<pre><code>" \n    [{'category': '电脑和笔记本', 'products': ['TechPro 超极本', 'BlueWave 游戏本', 'PowerLite Convertible', 'TechPro Desktop', 'BlueWave Chromebook']}]"
</code></pre><p>输出回答正确，但格式有误。</p>
<pre><code class="lang-python">customer_msg_3 = <span class="hljs-string">f"""
告诉我关于smartx pro手机和fotosnap相机的信息，那款DSLR的。
我预算有限，你们有哪些性价比高的电视推荐？"""</span>

products_by_category_3 = find_category_and_product_v1(customer_msg_3,
                                                      products_and_category)
<span class="hljs-built_in">print</span>(products_by_category_3)
</code></pre>
<pre><code>    [{'category': '智能手机和配件', 'products': ['SmartX ProPhone']}, {'category': '相机和摄像机', 'products': ['FotoSnap DSLR Camera']}]

    [{'category': '电视和家庭影院系统', 'products': ['CineView 4K TV', 'SoundMax Home Theater', 'CineView 8K TV', 'SoundMax Soundbar', 'CineView OLED TV']}]
</code></pre><p>它看起来像是输出了正确的数据，但没有按照要求的格式输出。这使得将其解析为 Python 字典列表更加困难。</p>
<h2 id="三、更难的测试用例">三、更难的测试用例</h2>
<p>接着，我们可以给出一些在实际使用中，模型表现不如预期的查询。</p>
<pre><code class="lang-python">customer_msg_4 = <span class="hljs-string">f"""
告诉我关于CineView电视的信息，那款8K的，还有Gamesphere游戏机，X款的。
我预算有限，你们有哪些电脑？"""</span>

products_by_category_4 = find_category_and_product_v1(customer_msg_4,products_and_category)
<span class="hljs-built_in">print</span>(products_by_category_4)
</code></pre>
<pre><code>    [{'category': '电视和家庭影院系统', 'products': ['CineView 4K TV', 'SoundMax Home Theater', 'CineView 8K TV', 'SoundMax Soundbar', 'CineView OLED TV']}]
    [{'category': '游戏机和配件', 'products': ['GameSphere X', 'ProGamer Controller', 'GameSphere Y', 'ProGamer Racing Wheel', 'GameSphere VR Headset']}]
    [{'category': '电脑和笔记本', 'products': ['TechPro 超极本', 'BlueWave 游戏本', 'PowerLite Convertible', 'TechPro Desktop', 'BlueWave Chromebook']}]
</code></pre><h2 id="四、修改指令以处理难测试用例">四、修改指令以处理难测试用例</h2>
<p>综上，我们实现的最初版本在上述一些测试用例中表现不尽如人意。</p>
<p>为提升效果，我们在提示中添加了以下内容：不要输出任何不在 JSON 格式中的附加文本，并添加了第二个示例，使用用户和助手消息进行 few-shot 提示。</p>
<pre><code class="lang-python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">find_category_and_product_v2</span>(<span class="hljs-params">user_input,products_and_category</span>):
    <span class="hljs-string">"""
    从用户输入中获取到产品和类别

    添加：不要输出任何不符合 JSON 格式的额外文本。
    添加了第二个示例（用于 few-shot 提示），用户询问最便宜的计算机。
    在这两个 few-shot 示例中，显示的响应只是 JSON 格式的完整产品列表。

    参数：
    user_input：用户的查询
    products_and_category：产品类型和对应产品的字典    
    """</span>
    delimiter = <span class="hljs-string">"####"</span>
    system_message = <span class="hljs-string">f"""
    您将提供客户服务查询。\
    客户服务查询将用<span class="hljs-subst">{delimiter}</span>字符分隔。
    输出一个 Python列表，列表中的每个对象都是 JSON 对象，每个对象的格式如下：
        '类别': &lt;电脑和笔记本, 智能手机和配件, 电视和家庭影院系统, \
    游戏机和配件, 音频设备, 相机和摄像机中的一个&gt;,
    以及
        '名称': &lt;必须在下面允许的产品中找到的产品列表&gt;
    不要输出任何不是 JSON 格式的额外文本。
    输出请求的 JSON 后，不要写任何解释性的文本。

    其中类别和产品必须在客户服务查询中找到。
    如果提到了一个产品，它必须与下面允许的产品列表中的正确类别关联。
    如果没有找到产品或类别，输出一个空列表。

    根据产品名称和产品类别与客户服务查询的相关性，列出所有相关的产品。
    不要从产品的名称中假设任何特性或属性，如相对质量或价格。

    允许的产品以 JSON 格式提供。
    每个项目的键代表类别。
    每个项目的值是该类别中的产品列表。
    允许的产品：<span class="hljs-subst">{products_and_category}</span>

    """</span>

    few_shot_user_1 = <span class="hljs-string">"""我想要最贵的电脑。你推荐哪款？"""</span>
    few_shot_assistant_1 = <span class="hljs-string">""" 
    [{'category': '电脑和笔记本', \
'products': ['TechPro 超极本', 'BlueWave 游戏本', 'PowerLite Convertible', 'TechPro Desktop', 'BlueWave Chromebook']}]
     """</span>

    few_shot_user_2 = <span class="hljs-string">"""我想要最便宜的电脑。你推荐哪款？"""</span>
    few_shot_assistant_2 = <span class="hljs-string">""" 
    [{'category': '电脑和笔记本', \
'products': ['TechPro 超极本', 'BlueWave 游戏本', 'PowerLite Convertible', 'TechPro Desktop', 'BlueWave Chromebook']}]
    """</span>

    messages =  [  
    {<span class="hljs-string">'role'</span>:<span class="hljs-string">'system'</span>, <span class="hljs-string">'content'</span>: system_message},    
    {<span class="hljs-string">'role'</span>:<span class="hljs-string">'user'</span>, <span class="hljs-string">'content'</span>: <span class="hljs-string">f"<span class="hljs-subst">{delimiter}</span><span class="hljs-subst">{few_shot_user_1}</span><span class="hljs-subst">{delimiter}</span>"</span>},  
    {<span class="hljs-string">'role'</span>:<span class="hljs-string">'assistant'</span>, <span class="hljs-string">'content'</span>: few_shot_assistant_1 },
    {<span class="hljs-string">'role'</span>:<span class="hljs-string">'user'</span>, <span class="hljs-string">'content'</span>: <span class="hljs-string">f"<span class="hljs-subst">{delimiter}</span><span class="hljs-subst">{few_shot_user_2}</span><span class="hljs-subst">{delimiter}</span>"</span>},  
    {<span class="hljs-string">'role'</span>:<span class="hljs-string">'assistant'</span>, <span class="hljs-string">'content'</span>: few_shot_assistant_2 },
    {<span class="hljs-string">'role'</span>:<span class="hljs-string">'user'</span>, <span class="hljs-string">'content'</span>: <span class="hljs-string">f"<span class="hljs-subst">{delimiter}</span><span class="hljs-subst">{user_input}</span><span class="hljs-subst">{delimiter}</span>"</span>},  
    ] 
    <span class="hljs-keyword">return</span> get_completion_from_messages(messages)
</code></pre>
<h2 id="五、在难测试用例上评估修改后的指令">五、在难测试用例上评估修改后的指令</h2>
<p>我们可以在之前表现不如预期的较难测试用例上评估改进后系统的效果：</p>
<pre><code class="lang-python">customer_msg_3 = <span class="hljs-string">f"""
告诉我关于smartx pro手机和fotosnap相机的信息，那款DSLR的。
另外，你们有哪些电视？"""</span>

products_by_category_3 = find_category_and_product_v2(customer_msg_3,
                                                      products_and_category)
<span class="hljs-built_in">print</span>(products_by_category_3)
</code></pre>
<pre><code>    [{'category': '智能手机和配件', 'products': ['SmartX ProPhone']}, {'category': '相机和摄像机', 'products': ['FotoSnap DSLR Camera', 'ActionCam 4K', 'FotoSnap Mirrorless Camera', 'ZoomMaster Camcorder', 'FotoSnap Instant Camera']}, {'category': '电视和家庭影院系统', 'products': ['CineView 4K TV', 'SoundMax Home Theater', 'CineView 8K TV', 'SoundMax Soundbar', 'CineView OLED TV']}]
</code></pre><h2 id="六、回归测试：验证模型在以前的测试用例上仍然有效">六、回归测试：验证模型在以前的测试用例上仍然有效</h2>
<p>检查并修复模型以提高难以测试的用例效果，同时确保此修正不会对先前的测试用例性能造成负面影响。</p>
<pre><code class="lang-python">customer_msg_0 = <span class="hljs-string">f"""如果我预算有限，我可以买哪款电视？"""</span>

products_by_category_0 = find_category_and_product_v2(customer_msg_0,
                                                      products_and_category)
<span class="hljs-built_in">print</span>(products_by_category_0)
</code></pre>
<pre><code>    [{'category': '电视和家庭影院系统', 'products': ['CineView 4K TV', 'SoundMax Home Theater', 'CineView 8K TV', 'SoundMax Soundbar', 'CineView OLED TV']}]
</code></pre><h2 id="七、收集开发集进行自动化测试">七、收集开发集进行自动化测试</h2>
<p>当我们的应用程序逐渐成熟，测试的重要性也随之增加。通常，当我们仅处理少量样本，手动运行测试并对结果进行评估是可行的。然而，随着开发集的增大，这种方法变得既繁琐又低效。此时，就需要引入自动化测试来提高我们的工作效率。下面将开始编写代码来自动化测试流程，可以帮助您提升效率并确保测试的准确率。</p>
<p>以下是一些用户问题的标准答案，用于评估 LLM 回答的准确度，与机器学习中的验证集的作用相当。</p>
<pre><code class="lang-python">msg_ideal_pairs_set = [

    <span class="hljs-comment"># eg 0</span>
    {<span class="hljs-string">'customer_msg'</span>:<span class="hljs-string">"""如果我预算有限，我可以买哪种电视？"""</span>,
     <span class="hljs-string">'ideal_answer'</span>:{
        <span class="hljs-string">'电视和家庭影院系统'</span>:<span class="hljs-built_in">set</span>(
            [<span class="hljs-string">'CineView 4K TV'</span>, <span class="hljs-string">'SoundMax Home Theater'</span>, <span class="hljs-string">'CineView 8K TV'</span>, <span class="hljs-string">'SoundMax Soundbar'</span>, <span class="hljs-string">'CineView OLED TV'</span>]
        )}
    },

    <span class="hljs-comment"># eg 1</span>
    {<span class="hljs-string">'customer_msg'</span>:<span class="hljs-string">"""我需要一个智能手机的充电器"""</span>,
     <span class="hljs-string">'ideal_answer'</span>:{
        <span class="hljs-string">'智能手机和配件'</span>:<span class="hljs-built_in">set</span>(
            [<span class="hljs-string">'MobiTech PowerCase'</span>, <span class="hljs-string">'MobiTech Wireless Charger'</span>, <span class="hljs-string">'SmartX EarBuds'</span>]
        )}
    },
    <span class="hljs-comment"># eg 2</span>
    {<span class="hljs-string">'customer_msg'</span>:<span class="hljs-string">f"""你有什么样的电脑"""</span>,
     <span class="hljs-string">'ideal_answer'</span>:{
           <span class="hljs-string">'电脑和笔记本'</span>:<span class="hljs-built_in">set</span>(
               [<span class="hljs-string">'TechPro 超极本'</span>, <span class="hljs-string">'BlueWave 游戏本'</span>, <span class="hljs-string">'PowerLite Convertible'</span>, <span class="hljs-string">'TechPro Desktop'</span>, <span class="hljs-string">'BlueWave Chromebook'</span>
               ])
                }
    },

    <span class="hljs-comment"># eg 3</span>
    {<span class="hljs-string">'customer_msg'</span>:<span class="hljs-string">f"""告诉我关于smartx pro手机和fotosnap相机的信息，那款DSLR的。\
另外，你们有哪些电视？"""</span>,
     <span class="hljs-string">'ideal_answer'</span>:{
        <span class="hljs-string">'智能手机和配件'</span>:<span class="hljs-built_in">set</span>(
            [<span class="hljs-string">'SmartX ProPhone'</span>]),
        <span class="hljs-string">'相机和摄像机'</span>:<span class="hljs-built_in">set</span>(
            [<span class="hljs-string">'FotoSnap DSLR Camera'</span>]),
        <span class="hljs-string">'电视和家庭影院系统'</span>:<span class="hljs-built_in">set</span>(
            [<span class="hljs-string">'CineView 4K TV'</span>, <span class="hljs-string">'SoundMax Home Theater'</span>,<span class="hljs-string">'CineView 8K TV'</span>, <span class="hljs-string">'SoundMax Soundbar'</span>, <span class="hljs-string">'CineView OLED TV'</span>])
        }
    }, 

    <span class="hljs-comment"># eg 4</span>
    {<span class="hljs-string">'customer_msg'</span>:<span class="hljs-string">"""告诉我关于CineView电视，那款8K电视、\
     Gamesphere游戏机和X游戏机的信息。我的预算有限，你们有哪些电脑？"""</span>,
     <span class="hljs-string">'ideal_answer'</span>:{
        <span class="hljs-string">'电视和家庭影院系统'</span>:<span class="hljs-built_in">set</span>(
            [<span class="hljs-string">'CineView 8K TV'</span>]),
        <span class="hljs-string">'游戏机和配件'</span>:<span class="hljs-built_in">set</span>(
            [<span class="hljs-string">'GameSphere X'</span>]),
        <span class="hljs-string">'电脑和笔记本'</span>:<span class="hljs-built_in">set</span>(
            [<span class="hljs-string">'TechPro Ultrabook'</span>, <span class="hljs-string">'BlueWave Gaming Laptop'</span>, <span class="hljs-string">'PowerLite Convertible'</span>, <span class="hljs-string">'TechPro Desktop'</span>, <span class="hljs-string">'BlueWave Chromebook'</span>])
        }
    },

    <span class="hljs-comment"># eg 5</span>
    {<span class="hljs-string">'customer_msg'</span>:<span class="hljs-string">f"""你们有哪些智能手机"""</span>,
     <span class="hljs-string">'ideal_answer'</span>:{
           <span class="hljs-string">'智能手机和配件'</span>:<span class="hljs-built_in">set</span>(
               [<span class="hljs-string">'SmartX ProPhone'</span>, <span class="hljs-string">'MobiTech PowerCase'</span>, <span class="hljs-string">'SmartX MiniPhone'</span>, <span class="hljs-string">'MobiTech Wireless Charger'</span>, <span class="hljs-string">'SmartX EarBuds'</span>
               ])
                    }
    },
    <span class="hljs-comment"># eg 6</span>
    {<span class="hljs-string">'customer_msg'</span>:<span class="hljs-string">f"""我预算有限。你能向我推荐一些智能手机吗？"""</span>,
     <span class="hljs-string">'ideal_answer'</span>:{
        <span class="hljs-string">'智能手机和配件'</span>:<span class="hljs-built_in">set</span>(
            [<span class="hljs-string">'SmartX EarBuds'</span>, <span class="hljs-string">'SmartX MiniPhone'</span>, <span class="hljs-string">'MobiTech PowerCase'</span>, <span class="hljs-string">'SmartX ProPhone'</span>, <span class="hljs-string">'MobiTech Wireless Charger'</span>]
        )}
    },

    <span class="hljs-comment"># eg 7 # this will output a subset of the ideal answer</span>
    {<span class="hljs-string">'customer_msg'</span>:<span class="hljs-string">f"""有哪些游戏机适合我喜欢赛车游戏的朋友？"""</span>,
     <span class="hljs-string">'ideal_answer'</span>:{
        <span class="hljs-string">'游戏机和配件'</span>:<span class="hljs-built_in">set</span>([
            <span class="hljs-string">'GameSphere X'</span>,
            <span class="hljs-string">'ProGamer Controller'</span>,
            <span class="hljs-string">'GameSphere Y'</span>,
            <span class="hljs-string">'ProGamer Racing Wheel'</span>,
            <span class="hljs-string">'GameSphere VR Headset'</span>
     ])}
    },
    <span class="hljs-comment"># eg 8</span>
    {<span class="hljs-string">'customer_msg'</span>:<span class="hljs-string">f"""送给我摄像师朋友什么礼物合适？"""</span>,
     <span class="hljs-string">'ideal_answer'</span>: {
        <span class="hljs-string">'相机和摄像机'</span>:<span class="hljs-built_in">set</span>([
        <span class="hljs-string">'FotoSnap DSLR Camera'</span>, <span class="hljs-string">'ActionCam 4K'</span>, <span class="hljs-string">'FotoSnap Mirrorless Camera'</span>, <span class="hljs-string">'ZoomMaster Camcorder'</span>, <span class="hljs-string">'FotoSnap Instant Camera'</span>
        ])}
    },

    <span class="hljs-comment"># eg 9</span>
    {<span class="hljs-string">'customer_msg'</span>:<span class="hljs-string">f"""我想要一台热水浴缸时光机"""</span>,
     <span class="hljs-string">'ideal_answer'</span>: []
    }

]
</code></pre>
<h2 id="八、通过与理想答案比较来评估测试用例">八、通过与理想答案比较来评估测试用例</h2>
<p>我们通过以下函数<code>eval_response_with_ideal</code>来评估 LLM 回答的准确度，该函数通过将 LLM 回答与理想答案进行比较来评估系统在测试用例上的效果。</p>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">def</span> <span class="hljs-title function_">eval_response_with_ideal</span>(<span class="hljs-params">response,
                              ideal,
                              debug=<span class="hljs-literal">False</span></span>):
    <span class="hljs-string">"""
    评估回复是否与理想答案匹配

    参数：
    response: 回复的内容
    ideal: 理想的答案
    debug: 是否打印调试信息
    """</span>
    <span class="hljs-keyword">if</span> debug:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"回复："</span>)
        <span class="hljs-built_in">print</span>(response)

    <span class="hljs-comment"># json.loads() 只能解析双引号，因此此处将单引号替换为双引号</span>
    json_like_str = response.replace(<span class="hljs-string">"'"</span>,<span class="hljs-string">'"'</span>)

    <span class="hljs-comment"># 解析为一系列的字典</span>
    l_of_d = json.loads(json_like_str)

    <span class="hljs-comment"># 当响应为空，即没有找到任何商品时</span>
    <span class="hljs-keyword">if</span> l_of_d == [] <span class="hljs-keyword">and</span> ideal == []:
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>

    <span class="hljs-comment"># 另外一种异常情况是，标准答案数量与回复答案数量不匹配</span>
    <span class="hljs-keyword">elif</span> l_of_d == [] <span class="hljs-keyword">or</span> ideal == []:
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>

    <span class="hljs-comment"># 统计正确答案数量</span>
    correct = <span class="hljs-number">0</span>    

    <span class="hljs-keyword">if</span> debug:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"l_of_d is"</span>)
        <span class="hljs-built_in">print</span>(l_of_d)

    <span class="hljs-comment"># 对每一个问答对  </span>
    <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> l_of_d:

        <span class="hljs-comment"># 获取产品和目录</span>
        cat = d.get(<span class="hljs-string">'category'</span>)
        prod_l = d.get(<span class="hljs-string">'products'</span>)
        <span class="hljs-comment"># 有获取到产品和目录</span>
        <span class="hljs-keyword">if</span> cat <span class="hljs-keyword">and</span> prod_l:
            <span class="hljs-comment"># convert list to set for comparison</span>
            prod_set = <span class="hljs-built_in">set</span>(prod_l)
            <span class="hljs-comment"># get ideal set of products</span>
            ideal_cat = ideal.get(cat)
            <span class="hljs-keyword">if</span> ideal_cat:
                prod_set_ideal = <span class="hljs-built_in">set</span>(ideal.get(cat))
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">if</span> debug:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"没有在标准答案中找到目录 <span class="hljs-subst">{cat}</span>"</span>)
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"标准答案: <span class="hljs-subst">{ideal}</span>"</span>)
                <span class="hljs-keyword">continue</span>

            <span class="hljs-keyword">if</span> debug:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"产品集合：\n"</span>,prod_set)
                <span class="hljs-built_in">print</span>()
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"标准答案的产品集合：\n"</span>,prod_set_ideal)

            <span class="hljs-comment"># 查找到的产品集合和标准的产品集合一致</span>
            <span class="hljs-keyword">if</span> prod_set == prod_set_ideal:
                <span class="hljs-keyword">if</span> debug:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"正确"</span>)
                correct +=<span class="hljs-number">1</span>
            <span class="hljs-keyword">else</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"错误"</span>)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"产品集合: <span class="hljs-subst">{prod_set}</span>"</span>)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"标准的产品集合: <span class="hljs-subst">{prod_set_ideal}</span>"</span>)
                <span class="hljs-keyword">if</span> prod_set &lt;= prod_set_ideal:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"回答是标准答案的一个子集"</span>)
                <span class="hljs-keyword">elif</span> prod_set &gt;= prod_set_ideal:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"回答是标准答案的一个超集"</span>)

    <span class="hljs-comment"># 计算正确答案数</span>
    pc_correct = correct / <span class="hljs-built_in">len</span>(l_of_d)

    <span class="hljs-keyword">return</span> pc_correct
</code></pre>
<p>我们使用上述测试用例中的一个进行测试，首先看一下标准回答：</p>
<pre><code class="lang-python"><span class="hljs-built_in">print</span>(<span class="hljs-string">f'用户提问: <span class="hljs-subst">{msg_ideal_pairs_set[<span class="hljs-number">7</span>][<span class="hljs-string">"customer_msg"</span>]}</span>'</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f'标准答案: <span class="hljs-subst">{msg_ideal_pairs_set[<span class="hljs-number">7</span>][<span class="hljs-string">"ideal_answer"</span>]}</span>'</span>)
</code></pre>
<pre><code>用户提问: 有哪些游戏机适合我喜欢赛车游戏的朋友？
标准答案: {'游戏机和配件': {'ProGamer Racing Wheel', 'ProGamer Controller', 'GameSphere Y', 'GameSphere VR Headset', 'GameSphere X'}}
</code></pre><p>再对比 LLM 回答，并使用验证函数进行评分：</p>
<pre><code class="lang-python">response = find_category_and_product_v2(msg_ideal_pairs_set[<span class="hljs-number">7</span>][<span class="hljs-string">"customer_msg"</span>],
                                         products_and_category)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f'回答: <span class="hljs-subst">{response}</span>'</span>)

eval_response_with_ideal(response,
                              msg_ideal_pairs_set[<span class="hljs-number">7</span>][<span class="hljs-string">"ideal_answer"</span>])
</code></pre>
<pre><code>回答:  
    [{'category': '游戏机和配件', 'products': ['GameSphere X', 'ProGamer Controller', 'GameSphere Y', 'ProGamer Racing Wheel', 'GameSphere VR Headset']}]






1.0
</code></pre><p>可见该验证函数的打分是准确的。</p>
<h2 id="九、在所有测试用例上运行评估，并计算正确的用例比例">九、在所有测试用例上运行评估，并计算正确的用例比例</h2>
<p>下面我们来对测试用例中的全部问题进行验证，并计算 LLM 回答正确的准确率</p>
<blockquote>
<p>注意：如果任何 API 调用超时，将无法运行</p>
</blockquote>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> time

score_accum = <span class="hljs-number">0</span>
<span class="hljs-keyword">for</span> i, pair <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(msg_ideal_pairs_set):
    time.sleep(<span class="hljs-number">20</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"示例 <span class="hljs-subst">{i}</span>"</span>)

    customer_msg = pair[<span class="hljs-string">'customer_msg'</span>]
    ideal = pair[<span class="hljs-string">'ideal_answer'</span>]

    <span class="hljs-comment"># print("Customer message",customer_msg)</span>
    <span class="hljs-comment"># print("ideal:",ideal)</span>
    response = find_category_and_product_v2(customer_msg,
                                                      products_and_category)


    <span class="hljs-comment"># print("products_by_category",products_by_category)</span>
    score = eval_response_with_ideal(response,ideal,debug=<span class="hljs-literal">False</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{i}</span>: <span class="hljs-subst">{score}</span>"</span>)
    score_accum += score


n_examples = <span class="hljs-built_in">len</span>(msg_ideal_pairs_set)
fraction_correct = score_accum / n_examples
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"正确比例为 <span class="hljs-subst">{n_examples}</span>: <span class="hljs-subst">{fraction_correct}</span>"</span>)
</code></pre>
<pre><code>示例 0
0: 1.0
示例 1
错误
产品集合: {'SmartX ProPhone'}
标准的产品集合: {'MobiTech Wireless Charger', 'SmartX EarBuds', 'MobiTech PowerCase'}
1: 0.0
示例 2
2: 1.0
示例 3
3: 1.0
示例 4
错误
产品集合: {'SoundMax Home Theater', 'CineView 8K TV', 'CineView 4K TV', 'CineView OLED TV', 'SoundMax Soundbar'}
标准的产品集合: {'CineView 8K TV'}
回答是标准答案的一个超集
错误
产品集合: {'ProGamer Racing Wheel', 'ProGamer Controller', 'GameSphere Y', 'GameSphere VR Headset', 'GameSphere X'}
标准的产品集合: {'GameSphere X'}
回答是标准答案的一个超集
错误
产品集合: {'TechPro 超极本', 'TechPro Desktop', 'BlueWave Chromebook', 'PowerLite Convertible', 'BlueWave 游戏本'}
标准的产品集合: {'TechPro Desktop', 'BlueWave Chromebook', 'TechPro Ultrabook', 'PowerLite Convertible', 'BlueWave Gaming Laptop'}
4: 0.0
示例 5
错误
产品集合: {'SmartX ProPhone'}
标准的产品集合: {'MobiTech Wireless Charger', 'SmartX EarBuds', 'SmartX MiniPhone', 'SmartX ProPhone', 'MobiTech PowerCase'}
回答是标准答案的一个子集
5: 0.0
示例 6
错误
产品集合: {'SmartX ProPhone'}
标准的产品集合: {'MobiTech Wireless Charger', 'SmartX EarBuds', 'SmartX MiniPhone', 'SmartX ProPhone', 'MobiTech PowerCase'}
回答是标准答案的一个子集
6: 0.0
示例 7
7: 1.0
示例 8
8: 1.0
示例 9
9: 1
正确比例为 10: 0.6
</code></pre><p>使用 Prompt 构建应用程序的工作流程与使用监督学习构建应用程序的工作流程非常不同。因此，我们认为这是需要记住的一件好事，当您正在构建监督学习模型时，会感觉到迭代速度快了很多。</p>
<p>如果您并未亲身体验，可能会惊叹于仅有手动构建的极少样本，就可以产生高效的评估方法。您可能会认为，仅有 10 个样本是不具备统计意义的。但当您真正运用这种方式时，您可能会对向开发集中添加一些复杂样本所带来的效果提升感到惊讶。这对于帮助您和您的团队找到有效的 Prompt 和有效的系统非常有帮助。</p>
<p>在本章中，输出可以被定量评估，就像有一个期望的输出一样，您可以判断它是否给出了这个期望的输出。在下一章中，我们将探讨如何在更加模糊的情况下评估我们的输出。即正确答案可能不那么明确的情况。</p>
<h2 id="十、英文版">十、英文版</h2>
<p><strong>1. 找出产品和类别名称</strong></p>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> utils_en

products_and_category = utils_en.get_products_and_category()
products_and_category
</code></pre>
<pre><code>{'Computers and Laptops': ['TechPro Ultrabook',
  'BlueWave Gaming Laptop',
  'PowerLite Convertible',
  'TechPro Desktop',
  'BlueWave Chromebook'],
 'Smartphones and Accessories': ['SmartX ProPhone',
  'MobiTech PowerCase',
  'SmartX MiniPhone',
  'MobiTech Wireless Charger',
  'SmartX EarBuds'],
 'Televisions and Home Theater Systems': ['CineView 4K TV',
  'SoundMax Home Theater',
  'CineView 8K TV',
  'SoundMax Soundbar',
  'CineView OLED TV'],
 'Gaming Consoles and Accessories': ['GameSphere X',
  'ProGamer Controller',
  'GameSphere Y',
  'ProGamer Racing Wheel',
  'GameSphere VR Headset'],
 'Audio Equipment': ['AudioPhonic Noise-Canceling Headphones',
  'WaveSound Bluetooth Speaker',
  'AudioPhonic True Wireless Earbuds',
  'WaveSound Soundbar',
  'AudioPhonic Turntable'],
 'Cameras and Camcorders': ['FotoSnap DSLR Camera',
  'ActionCam 4K',
  'FotoSnap Mirrorless Camera',
  'ZoomMaster Camcorder',
  'FotoSnap Instant Camera']}
</code></pre><pre><code class="lang-python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">find_category_and_product_v1</span>(<span class="hljs-params">user_input, products_and_category</span>):
    <span class="hljs-string">"""
    从用户输入中获取到产品和类别

    参数：
    user_input：用户的查询
    products_and_category：产品类型和对应产品的字典
    """</span>

    <span class="hljs-comment"># 分隔符</span>
    delimiter = <span class="hljs-string">"####"</span>
    <span class="hljs-comment"># 定义的系统信息，陈述了需要 GPT 完成的工作</span>
    system_message = <span class="hljs-string">f"""
    You will be provided with customer service queries. \
    The customer service query will be delimited with <span class="hljs-subst">{delimiter}</span> characters.
    Output a Python list of json objects, where each object has the following format:
        'category': &lt;one of Computers and Laptops, Smartphones and Accessories, Televisions and Home Theater Systems, \
    Gaming Consoles and Accessories, Audio Equipment, Cameras and Camcorders&gt;,
    AND
        'products': &lt;a list of products that must be found in the allowed products below&gt;


    Where the categories and products must be found in the customer service query.
    If a product is mentioned, it must be associated with the correct category in the allowed products list below.
    If no products or categories are found, output an empty list.


    List out all products that are relevant to the customer service query based on how closely it relates
    to the product name and product category.
    Do not assume, from the name of the product, any features or attributes such as relative quality or price.

    The allowed products are provided in JSON format.
    The keys of each item represent the category.
    The values of each item is a list of products that are within that category.
    Allowed products: <span class="hljs-subst">{products_and_category}</span>


    """</span>
    <span class="hljs-comment"># 给出几个示例</span>
    few_shot_user_1 = <span class="hljs-string">"""I want the most expensive computer."""</span>
    few_shot_assistant_1 = <span class="hljs-string">""" 
    [{'category': 'Computers and Laptops', \
'products': ['TechPro Ultrabook', 'BlueWave Gaming Laptop', 'PowerLite Convertible', 'TechPro Desktop', 'BlueWave Chromebook']}]
    """</span>

    messages =  [  
    {<span class="hljs-string">'role'</span>:<span class="hljs-string">'system'</span>, <span class="hljs-string">'content'</span>: system_message},    
    {<span class="hljs-string">'role'</span>:<span class="hljs-string">'user'</span>, <span class="hljs-string">'content'</span>: <span class="hljs-string">f"<span class="hljs-subst">{delimiter}</span><span class="hljs-subst">{few_shot_user_1}</span><span class="hljs-subst">{delimiter}</span>"</span>},  
    {<span class="hljs-string">'role'</span>:<span class="hljs-string">'assistant'</span>, <span class="hljs-string">'content'</span>: few_shot_assistant_1 },
    {<span class="hljs-string">'role'</span>:<span class="hljs-string">'user'</span>, <span class="hljs-string">'content'</span>: <span class="hljs-string">f"<span class="hljs-subst">{delimiter}</span><span class="hljs-subst">{user_input}</span><span class="hljs-subst">{delimiter}</span>"</span>},  
    ] 
    <span class="hljs-keyword">return</span> get_completion_from_messages(messages)
</code></pre>
<p><strong>2. 在一些查询上进行评估</strong></p>
<pre><code class="lang-python"><span class="hljs-comment"># 第一个评估的查询</span>
customer_msg_0 = <span class="hljs-string">f"""Which TV can I buy if I'm on a budget?"""</span>

products_by_category_0 = find_category_and_product_v1(customer_msg_0,
                                                      products_and_category)
<span class="hljs-built_in">print</span>(products_by_category_0)
</code></pre>
<pre><code>    [{'category': 'Televisions and Home Theater Systems', 'products': ['CineView 4K TV', 'SoundMax Home Theater', 'CineView 8K TV', 'SoundMax Soundbar', 'CineView OLED TV']}]
</code></pre><pre><code class="lang-python"><span class="hljs-comment"># 第二个评估的查询</span>
customer_msg_1 = <span class="hljs-string">f"""I need a charger for my smartphone"""</span>

products_by_category_1 = find_category_and_product_v1(customer_msg_1,
                                                      products_and_category)
<span class="hljs-built_in">print</span>(products_by_category_1)
</code></pre>
<pre><code>    [{'category': 'Smartphones and Accessories', 'products': ['MobiTech PowerCase', 'MobiTech Wireless Charger', 'SmartX EarBuds']}]
</code></pre><pre><code class="lang-python"><span class="hljs-comment"># 第三个评估查询</span>
customer_msg_2 = <span class="hljs-string">f"""
What computers do you have?"""</span>

products_by_category_2 = find_category_and_product_v1(customer_msg_2,
                                                      products_and_category)
products_by_category_2
</code></pre>
<pre><code>" \n    [{'category': 'Computers and Laptops', 'products': ['TechPro Ultrabook', 'BlueWave Gaming Laptop', 'PowerLite Convertible', 'TechPro Desktop', 'BlueWave Chromebook']}]"
</code></pre><pre><code class="lang-python"><span class="hljs-comment"># 第四个查询，更复杂</span>
customer_msg_3 = <span class="hljs-string">f"""
tell me about the smartx pro phone and the fotosnap camera, the dslr one.
Also, what TVs do you have?"""</span>

products_by_category_3 = find_category_and_product_v1(customer_msg_3,
                                                      products_and_category)
<span class="hljs-built_in">print</span>(products_by_category_3)
</code></pre>
<pre><code>    [{'category': 'Smartphones and Accessories', 'products': ['SmartX ProPhone']}, {'category': 'Cameras and Camcorders', 'products': ['FotoSnap DSLR Camera']}, {'category': 'Televisions and Home Theater Systems', 'products': ['CineView 4K TV', 'SoundMax Home Theater', 'CineView 8K TV', 'SoundMax Soundbar', 'CineView OLED TV']}]
</code></pre><p><strong>3. 更难的测试用例</strong></p>
<pre><code class="lang-python">customer_msg_4 = <span class="hljs-string">f"""
tell me about the CineView TV, the 8K one, Gamesphere console, the X one.
I'm on a budget, what computers do you have?"""</span>

products_by_category_4 = find_category_and_product_v1(customer_msg_4,
                                                      products_and_category)
<span class="hljs-built_in">print</span>(products_by_category_4)
</code></pre>
<pre><code>    [{'category': 'Televisions and Home Theater Systems', 'products': ['CineView 8K TV']}, {'category': 'Gaming Consoles and Accessories', 'products': ['GameSphere X']}, {'category': 'Computers and Laptops', 'products': ['TechPro Ultrabook', 'BlueWave Gaming Laptop', 'PowerLite Convertible', 'TechPro Desktop', 'BlueWave Chromebook']}]
</code></pre><p><strong>4. 修改指令</strong></p>
<pre><code class="lang-python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">find_category_and_product_v2</span>(<span class="hljs-params">user_input, products_and_category</span>):
    <span class="hljs-string">"""
    从用户输入中获取到产品和类别
    添加：不要输出任何不符合 JSON 格式的额外文本。
    添加了第二个示例（用于 few-shot 提示），用户询问最便宜的计算机。
    在这两个 few-shot 示例中，显示的响应只是 JSON 格式的完整产品列表。

    参数：
    user_input：用户的查询
    products_and_category：产品类型和对应产品的字典
    """</span>
    delimiter = <span class="hljs-string">"####"</span>
    system_message = <span class="hljs-string">f"""
    You will be provided with customer service queries. \
    The customer service query will be delimited with <span class="hljs-subst">{delimiter}</span> characters.
    Output a Python list of JSON objects, where each object has the following format:
        'category': &lt;one of Computers and Laptops, Smartphones and Accessories, Televisions and Home Theater Systems, \
    Gaming Consoles and Accessories, Audio Equipment, Cameras and Camcorders&gt;,
    AND
        'products': &lt;a list of products that must be found in the allowed products below&gt;
    Do not output any additional text that is not in JSON format.
    Do not write any explanatory text after outputting the requested JSON.


    Where the categories and products must be found in the customer service query.
    If a product is mentioned, it must be associated with the correct category in the allowed products list below.
    If no products or categories are found, output an empty list.


    List out all products that are relevant to the customer service query based on how closely it relates
    to the product name and product category.
    Do not assume, from the name of the product, any features or attributes such as relative quality or price.

    The allowed products are provided in JSON format.
    The keys of each item represent the category.
    The values of each item is a list of products that are within that category.
    Allowed products: <span class="hljs-subst">{products_and_category}</span>


    """</span>

    few_shot_user_1 = <span class="hljs-string">"""I want the most expensive computer. What do you recommend?"""</span>
    few_shot_assistant_1 = <span class="hljs-string">""" 
    [{'category': 'Computers and Laptops', \
'products': ['TechPro Ultrabook', 'BlueWave Gaming Laptop', 'PowerLite Convertible', 'TechPro Desktop', 'BlueWave Chromebook']}]
    """</span>

    few_shot_user_2 = <span class="hljs-string">"""I want the most cheapest computer. What do you recommend?"""</span>
    few_shot_assistant_2 = <span class="hljs-string">""" 
    [{'category': 'Computers and Laptops', \
'products': ['TechPro Ultrabook', 'BlueWave Gaming Laptop', 'PowerLite Convertible', 'TechPro Desktop', 'BlueWave Chromebook']}]
    """</span>

    messages =  [  
    {<span class="hljs-string">'role'</span>:<span class="hljs-string">'system'</span>, <span class="hljs-string">'content'</span>: system_message},    
    {<span class="hljs-string">'role'</span>:<span class="hljs-string">'user'</span>, <span class="hljs-string">'content'</span>: <span class="hljs-string">f"<span class="hljs-subst">{delimiter}</span><span class="hljs-subst">{few_shot_user_1}</span><span class="hljs-subst">{delimiter}</span>"</span>},  
    {<span class="hljs-string">'role'</span>:<span class="hljs-string">'assistant'</span>, <span class="hljs-string">'content'</span>: few_shot_assistant_1 },
    {<span class="hljs-string">'role'</span>:<span class="hljs-string">'user'</span>, <span class="hljs-string">'content'</span>: <span class="hljs-string">f"<span class="hljs-subst">{delimiter}</span><span class="hljs-subst">{few_shot_user_2}</span><span class="hljs-subst">{delimiter}</span>"</span>},  
    {<span class="hljs-string">'role'</span>:<span class="hljs-string">'assistant'</span>, <span class="hljs-string">'content'</span>: few_shot_assistant_2 },
    {<span class="hljs-string">'role'</span>:<span class="hljs-string">'user'</span>, <span class="hljs-string">'content'</span>: <span class="hljs-string">f"<span class="hljs-subst">{delimiter}</span><span class="hljs-subst">{user_input}</span><span class="hljs-subst">{delimiter}</span>"</span>},  
    ] 
    <span class="hljs-keyword">return</span> get_completion_from_messages(messages)
</code></pre>
<p><strong>5. 进一步评估</strong></p>
<pre><code class="lang-python">customer_msg_3 = <span class="hljs-string">f"""
tell me about the smartx pro phone and the fotosnap camera, the dslr one.
Also, what TVs do you have?"""</span>

products_by_category_3 = find_category_and_product_v2(customer_msg_3,
                                                      products_and_category)
<span class="hljs-built_in">print</span>(products_by_category_3)
</code></pre>
<pre><code>    [{'category': 'Smartphones and Accessories', 'products': ['SmartX ProPhone']}, {'category': 'Cameras and Camcorders', 'products': ['FotoSnap DSLR Camera']}, {'category': 'Televisions and Home Theater Systems', 'products': ['CineView 4K TV', 'SoundMax Home Theater', 'CineView 8K TV', 'SoundMax Soundbar', 'CineView OLED TV']}]
</code></pre><p><strong>6. 回归测试</strong></p>
<pre><code class="lang-python">customer_msg_0 = <span class="hljs-string">f"""Which TV can I buy if I'm on a budget?"""</span>

products_by_category_0 = find_category_and_product_v2(customer_msg_0,
                                                      products_and_category)
<span class="hljs-built_in">print</span>(products_by_category_0)
</code></pre>
<pre><code>    [{'category': 'Televisions and Home Theater Systems', 'products': ['CineView 4K TV', 'SoundMax Home Theater', 'CineView 8K TV', 'SoundMax Soundbar', 'CineView OLED TV']}]
</code></pre><p><strong>7. 自动化测试</strong></p>
<pre><code class="lang-python">msg_ideal_pairs_set = [

    <span class="hljs-comment"># eg 0</span>
    {<span class="hljs-string">'customer_msg'</span>:<span class="hljs-string">"""Which TV can I buy if I'm on a budget?"""</span>,
     <span class="hljs-string">'ideal_answer'</span>:{
        <span class="hljs-string">'Televisions and Home Theater Systems'</span>:<span class="hljs-built_in">set</span>(
            [<span class="hljs-string">'CineView 4K TV'</span>, <span class="hljs-string">'SoundMax Home Theater'</span>, <span class="hljs-string">'CineView 8K TV'</span>, <span class="hljs-string">'SoundMax Soundbar'</span>, <span class="hljs-string">'CineView OLED TV'</span>]
        )}
    },

    <span class="hljs-comment"># eg 1</span>
    {<span class="hljs-string">'customer_msg'</span>:<span class="hljs-string">"""I need a charger for my smartphone"""</span>,
     <span class="hljs-string">'ideal_answer'</span>:{
        <span class="hljs-string">'Smartphones and Accessories'</span>:<span class="hljs-built_in">set</span>(
            [<span class="hljs-string">'MobiTech PowerCase'</span>, <span class="hljs-string">'MobiTech Wireless Charger'</span>, <span class="hljs-string">'SmartX EarBuds'</span>]
        )}
    },
    <span class="hljs-comment"># eg 2</span>
    {<span class="hljs-string">'customer_msg'</span>:<span class="hljs-string">f"""What computers do you have?"""</span>,
     <span class="hljs-string">'ideal_answer'</span>:{
           <span class="hljs-string">'Computers and Laptops'</span>:<span class="hljs-built_in">set</span>(
               [<span class="hljs-string">'TechPro Ultrabook'</span>, <span class="hljs-string">'BlueWave Gaming Laptop'</span>, <span class="hljs-string">'PowerLite Convertible'</span>, <span class="hljs-string">'TechPro Desktop'</span>, <span class="hljs-string">'BlueWave Chromebook'</span>
               ])
                }
    },

    <span class="hljs-comment"># eg 3</span>
    {<span class="hljs-string">'customer_msg'</span>:<span class="hljs-string">f"""tell me about the smartx pro phone and \
    the fotosnap camera, the dslr one.\
    Also, what TVs do you have?"""</span>,
     <span class="hljs-string">'ideal_answer'</span>:{
        <span class="hljs-string">'Smartphones and Accessories'</span>:<span class="hljs-built_in">set</span>(
            [<span class="hljs-string">'SmartX ProPhone'</span>]),
        <span class="hljs-string">'Cameras and Camcorders'</span>:<span class="hljs-built_in">set</span>(
            [<span class="hljs-string">'FotoSnap DSLR Camera'</span>]),
        <span class="hljs-string">'Televisions and Home Theater Systems'</span>:<span class="hljs-built_in">set</span>(
            [<span class="hljs-string">'CineView 4K TV'</span>, <span class="hljs-string">'SoundMax Home Theater'</span>,<span class="hljs-string">'CineView 8K TV'</span>, <span class="hljs-string">'SoundMax Soundbar'</span>, <span class="hljs-string">'CineView OLED TV'</span>])
        }
    }, 

    <span class="hljs-comment"># eg 4</span>
    {<span class="hljs-string">'customer_msg'</span>:<span class="hljs-string">"""tell me about the CineView TV, the 8K one, Gamesphere console, the X one.
I'm on a budget, what computers do you have?"""</span>,
     <span class="hljs-string">'ideal_answer'</span>:{
        <span class="hljs-string">'Televisions and Home Theater Systems'</span>:<span class="hljs-built_in">set</span>(
            [<span class="hljs-string">'CineView 8K TV'</span>]),
        <span class="hljs-string">'Gaming Consoles and Accessories'</span>:<span class="hljs-built_in">set</span>(
            [<span class="hljs-string">'GameSphere X'</span>]),
        <span class="hljs-string">'Computers and Laptops'</span>:<span class="hljs-built_in">set</span>(
            [<span class="hljs-string">'TechPro Ultrabook'</span>, <span class="hljs-string">'BlueWave Gaming Laptop'</span>, <span class="hljs-string">'PowerLite Convertible'</span>, <span class="hljs-string">'TechPro Desktop'</span>, <span class="hljs-string">'BlueWave Chromebook'</span>])
        }
    },

    <span class="hljs-comment"># eg 5</span>
    {<span class="hljs-string">'customer_msg'</span>:<span class="hljs-string">f"""What smartphones do you have?"""</span>,
     <span class="hljs-string">'ideal_answer'</span>:{
           <span class="hljs-string">'Smartphones and Accessories'</span>:<span class="hljs-built_in">set</span>(
               [<span class="hljs-string">'SmartX ProPhone'</span>, <span class="hljs-string">'MobiTech PowerCase'</span>, <span class="hljs-string">'SmartX MiniPhone'</span>, <span class="hljs-string">'MobiTech Wireless Charger'</span>, <span class="hljs-string">'SmartX EarBuds'</span>
               ])
                    }
    },
    <span class="hljs-comment"># eg 6</span>
    {<span class="hljs-string">'customer_msg'</span>:<span class="hljs-string">f"""I'm on a budget.  Can you recommend some smartphones to me?"""</span>,
     <span class="hljs-string">'ideal_answer'</span>:{
        <span class="hljs-string">'Smartphones and Accessories'</span>:<span class="hljs-built_in">set</span>(
            [<span class="hljs-string">'SmartX EarBuds'</span>, <span class="hljs-string">'SmartX MiniPhone'</span>, <span class="hljs-string">'MobiTech PowerCase'</span>, <span class="hljs-string">'SmartX ProPhone'</span>, <span class="hljs-string">'MobiTech Wireless Charger'</span>]
        )}
    },

    <span class="hljs-comment"># eg 7 # this will output a subset of the ideal answer</span>
    {<span class="hljs-string">'customer_msg'</span>:<span class="hljs-string">f"""What Gaming consoles would be good for my friend who is into racing games?"""</span>,
     <span class="hljs-string">'ideal_answer'</span>:{
        <span class="hljs-string">'Gaming Consoles and Accessories'</span>:<span class="hljs-built_in">set</span>([
            <span class="hljs-string">'GameSphere X'</span>,
            <span class="hljs-string">'ProGamer Controller'</span>,
            <span class="hljs-string">'GameSphere Y'</span>,
            <span class="hljs-string">'ProGamer Racing Wheel'</span>,
            <span class="hljs-string">'GameSphere VR Headset'</span>
     ])}
    },
    <span class="hljs-comment"># eg 8</span>
    {<span class="hljs-string">'customer_msg'</span>:<span class="hljs-string">f"""What could be a good present for my videographer friend?"""</span>,
     <span class="hljs-string">'ideal_answer'</span>: {
        <span class="hljs-string">'Cameras and Camcorders'</span>:<span class="hljs-built_in">set</span>([
        <span class="hljs-string">'FotoSnap DSLR Camera'</span>, <span class="hljs-string">'ActionCam 4K'</span>, <span class="hljs-string">'FotoSnap Mirrorless Camera'</span>, <span class="hljs-string">'ZoomMaster Camcorder'</span>, <span class="hljs-string">'FotoSnap Instant Camera'</span>
        ])}
    },

    <span class="hljs-comment"># eg 9</span>
    {<span class="hljs-string">'customer_msg'</span>:<span class="hljs-string">f"""I would like a hot tub time machine."""</span>,
     <span class="hljs-string">'ideal_answer'</span>: []
    }

]
</code></pre>
<p><strong>8. 与理想答案对比</strong></p>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">def</span> <span class="hljs-title function_">eval_response_with_ideal</span>(<span class="hljs-params">response,
                              ideal,
                              debug=<span class="hljs-literal">False</span></span>):
    <span class="hljs-string">"""
    评估回复是否与理想答案匹配

    参数：
    response: 回复的内容
    ideal: 理想的答案
    debug: 是否打印调试信息
    """</span>
    <span class="hljs-keyword">if</span> debug:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"回复："</span>)
        <span class="hljs-built_in">print</span>(response)

    <span class="hljs-comment"># json.loads() 只能解析双引号，因此此处将单引号替换为双引号</span>
    json_like_str = response.replace(<span class="hljs-string">"'"</span>,<span class="hljs-string">'"'</span>)

    <span class="hljs-comment"># 解析为一系列的字典</span>
    l_of_d = json.loads(json_like_str)

    <span class="hljs-comment"># 当响应为空，即没有找到任何商品时</span>
    <span class="hljs-keyword">if</span> l_of_d == [] <span class="hljs-keyword">and</span> ideal == []:
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>

    <span class="hljs-comment"># 另外一种异常情况是，标准答案数量与回复答案数量不匹配</span>
    <span class="hljs-keyword">elif</span> l_of_d == [] <span class="hljs-keyword">or</span> ideal == []:
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>

    <span class="hljs-comment"># 统计正确答案数量</span>
    correct = <span class="hljs-number">0</span>    

    <span class="hljs-keyword">if</span> debug:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"l_of_d is"</span>)
        <span class="hljs-built_in">print</span>(l_of_d)

    <span class="hljs-comment"># 对每一个问答对  </span>
    <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> l_of_d:

        <span class="hljs-comment"># 获取产品和目录</span>
        cat = d.get(<span class="hljs-string">'category'</span>)
        prod_l = d.get(<span class="hljs-string">'products'</span>)
        <span class="hljs-comment"># 有获取到产品和目录</span>
        <span class="hljs-keyword">if</span> cat <span class="hljs-keyword">and</span> prod_l:
            <span class="hljs-comment"># convert list to set for comparison</span>
            prod_set = <span class="hljs-built_in">set</span>(prod_l)
            <span class="hljs-comment"># get ideal set of products</span>
            ideal_cat = ideal.get(cat)
            <span class="hljs-keyword">if</span> ideal_cat:
                prod_set_ideal = <span class="hljs-built_in">set</span>(ideal.get(cat))
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">if</span> debug:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"没有在标准答案中找到目录 <span class="hljs-subst">{cat}</span>"</span>)
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"标准答案: <span class="hljs-subst">{ideal}</span>"</span>)
                <span class="hljs-keyword">continue</span>

            <span class="hljs-keyword">if</span> debug:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"产品集合：\n"</span>,prod_set)
                <span class="hljs-built_in">print</span>()
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"标准答案的产品集合：\n"</span>,prod_set_ideal)

            <span class="hljs-comment"># 查找到的产品集合和标准的产品集合一致</span>
            <span class="hljs-keyword">if</span> prod_set == prod_set_ideal:
                <span class="hljs-keyword">if</span> debug:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"正确"</span>)
                correct +=<span class="hljs-number">1</span>
            <span class="hljs-keyword">else</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"错误"</span>)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"产品集合: <span class="hljs-subst">{prod_set}</span>"</span>)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"标准的产品集合: <span class="hljs-subst">{prod_set_ideal}</span>"</span>)
                <span class="hljs-keyword">if</span> prod_set &lt;= prod_set_ideal:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"回答是标准答案的一个子集"</span>)
                <span class="hljs-keyword">elif</span> prod_set &gt;= prod_set_ideal:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"回答是标准答案的一个超集"</span>)

    <span class="hljs-comment"># 计算正确答案数</span>
    pc_correct = correct / <span class="hljs-built_in">len</span>(l_of_d)

    <span class="hljs-keyword">return</span> pc_correct
</code></pre>
<pre><code class="lang-python"><span class="hljs-built_in">print</span>(<span class="hljs-string">f'用户提问: <span class="hljs-subst">{msg_ideal_pairs_set[<span class="hljs-number">7</span>][<span class="hljs-string">"customer_msg"</span>]}</span>'</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f'标准答案: <span class="hljs-subst">{msg_ideal_pairs_set[<span class="hljs-number">7</span>][<span class="hljs-string">"ideal_answer"</span>]}</span>'</span>)
</code></pre>
<pre><code>用户提问: What Gaming consoles would be good for my friend who is into racing games?
标准答案: {'Gaming Consoles and Accessories': {'ProGamer Racing Wheel', 'ProGamer Controller', 'GameSphere Y', 'GameSphere VR Headset', 'GameSphere X'}}
</code></pre><pre><code class="lang-python">response = find_category_and_product_v2(msg_ideal_pairs_set[<span class="hljs-number">7</span>][<span class="hljs-string">"customer_msg"</span>],
                                         products_and_category)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f'回答: <span class="hljs-subst">{response}</span>'</span>)

eval_response_with_ideal(response,
                              msg_ideal_pairs_set[<span class="hljs-number">7</span>][<span class="hljs-string">"ideal_answer"</span>])
</code></pre>
<pre><code>回答:  
    [{'category': 'Gaming Consoles and Accessories', 'products': ['GameSphere X', 'ProGamer Controller', 'GameSphere Y', 'ProGamer Racing Wheel', 'GameSphere VR Headset']}]






1.0
</code></pre><p><strong>9. 计算正确比例</strong></p>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> time

score_accum = <span class="hljs-number">0</span>
<span class="hljs-keyword">for</span> i, pair <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(msg_ideal_pairs_set):
    time.sleep(<span class="hljs-number">20</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"示例 <span class="hljs-subst">{i}</span>"</span>)

    customer_msg = pair[<span class="hljs-string">'customer_msg'</span>]
    ideal = pair[<span class="hljs-string">'ideal_answer'</span>]

    <span class="hljs-comment"># print("Customer message",customer_msg)</span>
    <span class="hljs-comment"># print("ideal:",ideal)</span>
    response = find_category_and_product_v2(customer_msg,
                                                      products_and_category)


    <span class="hljs-comment"># print("products_by_category",products_by_category)</span>
    score = eval_response_with_ideal(response,ideal,debug=<span class="hljs-literal">False</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{i}</span>: <span class="hljs-subst">{score}</span>"</span>)
    score_accum += score


n_examples = <span class="hljs-built_in">len</span>(msg_ideal_pairs_set)
fraction_correct = score_accum / n_examples
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"正确比例为 <span class="hljs-subst">{n_examples}</span>: <span class="hljs-subst">{fraction_correct}</span>"</span>)
</code></pre>
<pre><code>示例 0
0: 1.0
示例 1
错误
产品集合: {'MobiTech Wireless Charger', 'SmartX EarBuds', 'SmartX MiniPhone', 'SmartX ProPhone', 'MobiTech PowerCase'}
标准的产品集合: {'MobiTech Wireless Charger', 'SmartX EarBuds', 'MobiTech PowerCase'}
回答是标准答案的一个超集
1: 0.0
示例 2
2: 1.0
示例 3
3: 1.0
示例 4
错误
产品集合: {'SoundMax Home Theater', 'CineView 8K TV', 'CineView 4K TV', 'CineView OLED TV', 'SoundMax Soundbar'}
标准的产品集合: {'CineView 8K TV'}
回答是标准答案的一个超集
错误
产品集合: {'ProGamer Racing Wheel', 'ProGamer Controller', 'GameSphere Y', 'GameSphere VR Headset', 'GameSphere X'}
标准的产品集合: {'GameSphere X'}
回答是标准答案的一个超集
4: 0.3333333333333333
示例 5
5: 1.0
示例 6
6: 1.0
示例 7
7: 1.0
示例 8
8: 1.0
示例 9
9: 1
正确比例为 10: 0.8333333333333334
</code></pre>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="8.-搭建一个带评估的端到端问答系统-Evaluation.html" class="navigation navigation-prev " aria-label="Previous page: 8. 搭建一个带评估的端到端系统 Evaluation">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="10.-评估（下）Evaluation-part2.html" class="navigation navigation-next " aria-label="Next page: 10. 评估（下）Evaluation-part2">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"9. 评估（上）Evaluation-part1","level":"3.10","depth":1,"next":{"title":"10. 评估（下）Evaluation-part2","level":"3.11","depth":1,"path":"C2/10.-评估（下）Evaluation-part2.md","ref":"C2/10.-评估（下）Evaluation-part2.md","articles":[]},"previous":{"title":"8. 搭建一个带评估的端到端系统 Evaluation","level":"3.9","depth":1,"path":"C2/8.-搭建一个带评估的端到端问答系统-Evaluation.md","ref":"C2/8.-搭建一个带评估的端到端问答系统-Evaluation.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"C2/9.-评估（上）-Evaluation-part1.md","mtime":"2024-08-23T21:42:59.785Z","type":"markdown"},"gitbook":{"version":"5.1.4","time":"2024-08-23T22:20:29.853Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

